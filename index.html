<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒ∞≈ü Bul | Kurumsal ƒ∞≈ü Uygulamasƒ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .error-msg { color: #ef4444; font-size: 0.75rem; font-weight: 600; margin-top: 0.25rem; display: none; }
        input:invalid { border-color: #ef4444; }
    </style>
</head>
<body class="bg-slate-50 font-sans">

    <nav class="bg-indigo-700 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-black tracking-tighter italic">üöÄ ƒ∞≈û BUL PRO</h1>
            <div id="userInfo" class="flex items-center gap-3">
                <span id="userBadge" class="text-[10px] bg-indigo-800 px-3 py-1 rounded-full font-bold">Misafir</span>
                <button onclick="logout()" id="logoutBtn" class="hidden text-xs bg-red-500 px-2 py-1 rounded">√áƒ±kƒ±≈ü</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-2xl">
        
        <div id="authModal" class="fixed inset-0 bg-indigo-950 z-[100] flex items-center justify-center p-6 text-white">
            <div class="w-full max-w-md bg-white text-gray-800 p-8 rounded-[2rem] shadow-2xl overflow-y-auto max-h-[95vh]">
                <h2 class="text-3xl font-black text-indigo-700 mb-2 text-center">Ho≈ü Geldiniz</h2>
                <p class="text-center text-gray-500 text-sm mb-6" id="authSubtitle">L√ºtfen hesabƒ±nƒ±za giri≈ü yapƒ±n.</p>
                
                <div class="space-y-3">
                    <div id="loginFieldWrapper">
                        <input id="authIdentifier" type="text" placeholder="E-posta veya Kullanƒ±cƒ± Adƒ±" class="w-full p-4 bg-gray-100 rounded-2xl outline-none focus:ring-2 ring-indigo-500">
                        <p id="error-identifier" class="error-msg ml-2"></p>
                    </div>

                    <div id="registerFields" class="hidden space-y-3 border-t pt-4">
                        <input id="authUsername" type="text" placeholder="Kullanƒ±cƒ± Adƒ± Se√ßin" class="w-full p-4 bg-gray-100 rounded-2xl outline-none focus:ring-2 ring-indigo-500">
                        <input id="authEmail" type="email" placeholder="E-posta Adresiniz" class="w-full p-4 bg-gray-100 rounded-2xl outline-none focus:ring-2 ring-indigo-500">
                        <select id="authUserType" class="w-full p-4 bg-gray-100 rounded-2xl outline-none">
                            <option value="seeker">ƒ∞≈ü Arƒ±yorum</option>
                            <option value="employer">ƒ∞≈ü Verenim</option>
                        </select>
                        <input id="authAge" type="number" min="18" max="99" placeholder="Ya≈üƒ±nƒ±z (Min 18)" class="w-full p-4 bg-gray-100 rounded-2xl outline-none">
                    </div>

                    <div class="relative">
                        <input id="authPass" type="password" placeholder="≈ûifreniz (En az 8 karakter)" class="w-full p-4 bg-gray-100 rounded-2xl outline-none focus:ring-2 ring-indigo-500">
                        <button onclick="togglePass('authPass')" class="absolute right-4 top-4 text-gray-400">
                            <i class="fa-solid fa-eye" id="eye-authPass"></i>
                        </button>
                    </div>

                    <div id="confirmPassWrapper" class="hidden relative">
                        <input id="authPassConfirm" type="password" placeholder="≈ûifreyi Tekrar Girin" class="w-full p-4 bg-gray-100 rounded-2xl outline-none focus:ring-2 ring-indigo-500">
                        <button onclick="togglePass('authPassConfirm')" class="absolute right-4 top-4 text-gray-400">
                            <i class="fa-solid fa-eye" id="eye-authPassConfirm"></i>
                        </button>
                    </div>
                    
                    <p id="general-error" class="error-msg text-center font-bold"></p>

                    <div class="flex flex-col gap-2 pt-2">
                        <button id="authSubmitBtn" onclick="handleAuth()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg">Giri≈ü Yap</button>
                        <button id="toggleRegBtn" onclick="toggleAuthMode()" class="w-full bg-gray-200 text-gray-700 font-bold py-4 rounded-2xl">Hesap Olu≈ütur</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-black text-slate-800">G√ºncel ƒ∞lanlar</h2>
            <button id="postBtn" onclick="openPostModal()" class="bg-indigo-600 text-white px-6 py-2.5 rounded-full font-bold hidden shadow-indigo-200 shadow-xl hover:scale-105 transition">ƒ∞lan Yayƒ±nla</button>
        </div>

        <div id="jobList" class="space-y-4 pb-20"></div>
    </div>

    <div id="postModal" class="fixed inset-0 bg-black bg-opacity-60 z-[110] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 id="modalTitle" class="font-black text-2xl mb-6 text-indigo-700">ƒ∞lan Detaylarƒ±</h3>
            <input type="hidden" id="editingJobId">
            <div class="space-y-4">
                <input id="title" type="text" placeholder="ƒ∞≈ü Ba≈ülƒ±ƒüƒ±" class="w-full p-4 bg-gray-50 rounded-2xl border outline-none focus:border-indigo-500">
                <div class="flex gap-2">
                    <input id="salary" type="text" placeholder="√úcret" class="w-full p-4 bg-gray-50 rounded-2xl border">
                    <input id="location" type="text" placeholder="Konum" class="w-full p-4 bg-gray-50 rounded-2xl border">
                </div>
                <div class="p-4 bg-indigo-50 rounded-2xl">
                    <p class="text-xs font-bold text-indigo-600 mb-3 uppercase tracking-wider">Aranan Ya≈ü Aralƒ±ƒüƒ±:</p>
                    <div class="grid grid-cols-2 gap-2 text-sm font-semibold">
                        <label class="flex items-center gap-2"><input type="checkbox" name="ageRange" value="18-24"> 18-24 Ya≈ü</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="ageRange" value="25-35"> 25-35 Ya≈ü</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="ageRange" value="35+"> 35+ Ya≈ü</label>
                    </div>
                </div>
                <input id="phone" type="text" placeholder="ƒ∞leti≈üim Tel" class="w-full p-4 bg-gray-50 rounded-2xl border">
                <textarea id="description" placeholder="≈ûartlar ve detaylar..." class="w-full p-4 bg-gray-50 rounded-2xl border h-32 outline-none"></textarea>
                <div class="flex gap-3 pt-2">
                    <button onclick="saveJob()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-extrabold shadow-lg">Yayƒ±nla</button>
                    <button onclick="closePostModal()" class="w-full bg-gray-100 text-gray-500 py-4 rounded-2xl font-bold">Kapat</button>
                </div>
            </div>
        </div>
    </div>

    <div id="messageModal" class="fixed inset-0 bg-black bg-opacity-50 z-[120] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xs rounded-[2rem] p-6 shadow-2xl text-center">
            <h3 class="font-bold text-xl mb-4 text-indigo-700">Ba≈üvuru Yap</h3>
            <textarea id="msgText" placeholder="Kƒ±saca kendinden bahset..." class="w-full p-4 bg-gray-50 rounded-2xl border h-32 outline-none mb-4"></textarea>
            <input type="hidden" id="currentJobId">
            <div class="flex gap-2">
                <button onclick="sendMessage()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">G√∂nder</button>
                <button onclick="document.getElementById('messageModal').classList.add('hidden')" class="w-full bg-gray-100 text-gray-500 py-3 rounded-xl font-bold">ƒ∞ptal</button>
            </div>
        </div>
    </div>

    <div id="inboxModal" class="fixed inset-0 bg-black bg-opacity-50 z-[120] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2rem] p-8 shadow-2xl max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-xl text-indigo-700">Gelen Ba≈üvurular</h3>
                <button onclick="document.getElementById('inboxModal').classList.add('hidden')" class="text-gray-400 text-2xl"><i class="fa-solid fa-x"></i></button>
            </div>
            <div id="messageList" class="space-y-4"></div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let isRegisterMode = false;

        window.onload = () => {
            const savedUser = localStorage.getItem('user');
            if(savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('authModal').classList.add('hidden');
                initApp();
            }
        };

        function togglePass(id) {
            const input = document.getElementById(id);
            const eye = document.getElementById('eye-' + id);
            if(input.type === 'password') {
                input.type = 'text';
                eye.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                eye.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        function showError(msg) {
            const errEl = document.getElementById('general-error');
            errEl.innerText = msg;
            errEl.style.display = 'block';
        }

        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            document.getElementById('registerFields').classList.toggle('hidden');
            document.getElementById('confirmPassWrapper').classList.toggle('hidden');
            document.getElementById('loginFieldWrapper').classList.toggle('hidden');
            document.getElementById('authSubmitBtn').innerText = isRegisterMode ? 'Kayƒ±t Ol ve Gir' : 'Giri≈ü Yap';
            document.getElementById('toggleRegBtn').innerText = isRegisterMode ? 'Vazge√ß' : 'Hesap Olu≈ütur';
            document.getElementById('authSubtitle').innerText = isRegisterMode ? 'Yeni bir hesap olu≈üturun.' : 'L√ºtfen hesabƒ±nƒ±za giri≈ü yapƒ±n.';
            document.getElementById('general-error').style.display = 'none';
        }

        async function handleAuth() {
            document.getElementById('general-error').style.display = 'none';
            const pass = document.getElementById('authPass').value;

            if(isRegisterMode) {
                const username = document.getElementById('authUsername').value;
                const email = document.getElementById('authEmail').value;
                const age = document.getElementById('authAge').value;
                const passConfirm = document.getElementById('authPassConfirm').value;
                const user_type = document.getElementById('authUserType').value;

                // Kontroller
                if(!username || !email || !pass || !age) return showError("T√ºm alanlarƒ± doldurun!");
                if(!email.includes('@')) return showError("Ge√ßerli bir e-posta girin!");
                if(username.length < 3) return showError("Kullanƒ±cƒ± adƒ± √ßok kƒ±sa!");
                if(pass.length < 8) return showError("≈ûifre en az 8 karakter olmalƒ±!");
                if(pass !== passConfirm) return showError("≈ûifreler uyu≈ümuyor!");
                if(age < 18) return showError("18 ya≈üƒ±ndan k√º√ß√ºkler kayƒ±t olamaz!");

                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username, email, password: pass, user_type, age: parseInt(age) })
                });
                const data = await res.json();
                if(data.error) return showError(data.error);
                currentUser = { username, email, user_type, age: parseInt(age) };
            } else {
                const identifier = document.getElementById('authIdentifier').value;
                if(!identifier || !pass) return showError("Bilgileri girin!");

                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ identifier, password: pass })
                });
                const data = await res.json();
                if(data.error) return showError(data.error);
                currentUser = data;
            }

            localStorage.setItem('user', JSON.stringify(currentUser));
            document.getElementById('authModal').classList.add('hidden');
            initApp();
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        function initApp() {
            document.getElementById('logoutBtn').classList.remove('hidden');
            document.getElementById('userBadge').innerText = currentUser.user_type === 'seeker' ? `üë§ ${currentUser.username} (${currentUser.age})` : `üíº ƒ∞≈ü Veren (${currentUser.username})`;
            if(currentUser.user_type === 'employer') {
                document.getElementById('postBtn').classList.remove('hidden');
            }
            loadJobs();
        }

        async function loadJobs() {
            const res = await fetch('/api/jobs');
            const jobs = await res.json();
            const list = document.getElementById('jobList');
            
            list.innerHTML = jobs.map(j => {
                let ageFit = true;
                if(currentUser.user_type === 'seeker') {
                    const ranges = j.age_range.split(', ');
                    ageFit = ranges.some(r => {
                        if(r === '35+' && currentUser.age >= 35) return true;
                        const [min, max] = r.split('-').map(Number);
                        return currentUser.age >= min && currentUser.age <= max;
                    });
                }
                const isOwner = currentUser.email === j.owner_email;

                return `
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 flex flex-col gap-3">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="font-extrabold text-xl text-indigo-900 leading-none">${j.title}</h3>
                            <div class="flex flex-wrap gap-2 mt-3">
                                <span class="text-[10px] bg-indigo-50 text-indigo-600 font-bold px-3 py-1 rounded-full"><i class="fa-solid fa-map-pin"></i> ${j.location}</span>
                                <span class="text-[10px] bg-orange-50 text-orange-600 font-bold px-3 py-1 rounded-full"><i class="fa-solid fa-users"></i> ${j.age_range}</span>
                            </div>
                        </div>
                        <span class="text-green-600 font-black text-xl">${j.salary}</span>
                    </div>
                    <p class="text-sm text-gray-500 font-medium">${j.description}</p>
                    ${!ageFit ? `<p class="text-red-500 text-[10px] font-bold italic underline">‚ö†Ô∏è Ya≈üƒ±nƒ±z uygun deƒüil.</p>` : ''}
                    <div class="flex gap-2 mt-4">
                        ${currentUser.user_type === 'seeker' ? `
                            <a href="tel:${j.phone}" class="flex-1 bg-indigo-50 text-indigo-700 text-center py-4 rounded-2xl text-xs font-black">ARA</a>
                            <button onclick="openMessageModal(${j.id})" class="flex-1 bg-indigo-600 text-white py-4 rounded-2xl text-xs font-black shadow-md">MESAJ G√ñNDER</button>
                        ` : (isOwner ? `
                            <button onclick="showMessages(${j.id})" class="flex-1 bg-indigo-50 text-indigo-700 py-4 rounded-2xl text-xs font-black">GELENLER</button>
                            <button onclick="openEditModal(${JSON.stringify(j).replace(/"/g, '&quot;')})" class="flex-1 bg-orange-500 text-white py-4 rounded-2xl text-xs font-black shadow-md">D√úZENLE</button>
                        ` : `<button disabled class="flex-1 bg-gray-100 text-gray-400 py-4 rounded-2xl text-xs font-black">BA≈ûKASININ ƒ∞LANI</button>`)}
                    </div>
                </div>`;
            }).join('');
        }

        // ƒ∞LAN FONKSƒ∞YONLARI (Aynen Korundu)
        function openPostModal() {
            document.getElementById('editingJobId').value = '';
            document.getElementById('modalTitle').innerText = "Yeni ƒ∞lan";
            clearForm();
            document.getElementById('postModal').classList.remove('hidden');
        }

        function openEditModal(jobData) {
            document.getElementById('editingJobId').value = jobData.id;
            document.getElementById('modalTitle').innerText = "ƒ∞lanƒ± D√ºzenle";
            document.getElementById('title').value = jobData.title;
            document.getElementById('salary').value = jobData.salary;
            document.getElementById('location').value = jobData.location;
            document.getElementById('phone').value = jobData.phone;
            document.getElementById('description').value = jobData.description;
            const ranges = jobData.age_range.split(', ');
            document.querySelectorAll('input[name="ageRange"]').forEach(cb => cb.checked = ranges.includes(cb.value));
            document.getElementById('postModal').classList.remove('hidden');
        }

        async function saveJob() {
            const editingId = document.getElementById('editingJobId').value;
            const selectedAges = Array.from(document.querySelectorAll('input[name="ageRange"]:checked')).map(c => c.value);
            const data = {
                owner_email: currentUser.email,
                title: document.getElementById('title').value,
                salary: document.getElementById('salary').value,
                location: document.getElementById('location').value,
                phone: document.getElementById('phone').value,
                description: document.getElementById('description').value,
                age_range: selectedAges.join(', ')
            };
            const method = editingId ? 'PUT' : 'POST';
            const url = editingId ? `/api/jobs/${editingId}` : '/api/jobs';
            await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
            closePostModal();
            loadJobs();
        }

        function clearForm() {
            document.getElementById('title').value = '';
            document.getElementById('salary').value = '';
            document.getElementById('location').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('description').value = '';
            document.querySelectorAll('input[name="ageRange"]').forEach(cb => cb.checked = false);
        }

        function closePostModal() { document.getElementById('postModal').classList.add('hidden'); }

        function openMessageModal(jobId) {
            document.getElementById('currentJobId').value = jobId;
            document.getElementById('messageModal').classList.remove('hidden');
        }

        async function sendMessage() {
            const data = {
                job_id: document.getElementById('currentJobId').value,
                sender_email: currentUser.email,
                sender_age: currentUser.age,
                message_text: document.getElementById('msgText').value
            };
            await fetch('/api/messages', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
            alert("Mesaj iletildi!");
            document.getElementById('messageModal').classList.add('hidden');
            document.getElementById('msgText').value = '';
        }

        async function showMessages(jobId) {
            const res = await fetch(`/api/messages/${jobId}`);
            const messages = await res.json();
            const list = document.getElementById('messageList');
            document.getElementById('inboxModal').classList.remove('hidden');
            list.innerHTML = messages.length === 0 ? '<p class="text-center text-gray-400">Hen√ºz ba≈üvuru yok.</p>' : 
            messages.map(m => `
                <div class="bg-gray-50 p-5 rounded-2xl border border-indigo-100">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full font-black">ADAY: ${m.sender_age} YA≈û</span>
                        <span class="text-[10px] text-gray-400 font-bold">${m.sender_email}</span>
                    </div>
                    <p class="text-sm text-gray-700 italic font-medium">"${m.message_text}"</p>
                </div>
            `).join('');
        }
    </script>
</body>
</html>