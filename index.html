<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ä°ÅŸ Bul | HÄ±zlÄ± ve GÃ¼venli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <nav class="bg-indigo-700 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold italic">ğŸš€ Ä°Å BUL</h1>
            <div id="userBadge" class="text-xs bg-indigo-800 px-3 py-1 rounded-full font-semibold"></div>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-2xl">
        <div id="loginModal" class="fixed inset-0 bg-indigo-900 z-[60] flex items-center justify-center p-6 text-white">
            <div class="text-center max-w-sm">
                <h2 class="text-3xl font-bold mb-6">HoÅŸ Geldin!</h2>
                <div class="space-y-4">
                    <button onclick="startApp('seeker')" class="w-full bg-white text-indigo-700 font-bold py-4 rounded-2xl shadow-xl">Ä°ÅŸ ArÄ±yorum</button>
                    <button onclick="startApp('employer')" class="w-full bg-indigo-500 text-white font-bold py-4 rounded-2xl shadow-xl border border-indigo-400">Ä°ÅŸ Verenim</button>
                </div>
            </div>
        </div>

        <div id="ageModal" class="fixed inset-0 bg-black bg-opacity-80 z-[70] hidden flex items-center justify-center p-6">
            <div class="bg-white p-6 rounded-3xl text-center w-full max-w-xs">
                <h3 class="text-gray-800 font-bold mb-4 text-lg text-indigo-600">KaÃ§ yaÅŸÄ±ndasÄ±n?</h3>
                <input id="userAge" type="number" class="w-full border-2 border-indigo-100 rounded-xl p-3 text-center text-2xl font-bold mb-4 focus:border-indigo-500 outline-none" placeholder="20">
                <button onclick="saveAge()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition">Uygulamaya Gir</button>
            </div>
        </div>

        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-extrabold text-gray-800 tracking-tight">Ä°lanlar</h2>
            <button id="postBtn" onclick="openPostModal()" class="bg-indigo-600 text-white px-5 py-2 rounded-full font-bold hidden shadow-lg hover:scale-105 transition">Ä°lan Ver</button>
        </div>

        <div id="jobList" class="space-y-4 pb-20 text-indigo-900"></div>
    </div>

    <div id="postModal" class="fixed inset-0 bg-black bg-opacity-50 z-[80] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-xl mb-4 text-indigo-700 border-b pb-2">Ä°ÅŸ DetaylarÄ±</h3>
            <div class="space-y-4">
                <input id="title" type="text" placeholder="Ä°ÅŸ BaÅŸlÄ±ÄŸÄ± (Ã–rn: Paket Servis)" class="w-full p-3 bg-gray-50 rounded-xl border focus:border-indigo-500 outline-none">
                <div class="flex gap-2">
                    <input id="salary" type="text" placeholder="Ãœcret" class="w-full p-3 bg-gray-50 rounded-xl border focus:border-indigo-500 outline-none">
                    <input id="location" type="text" placeholder="Konum" class="w-full p-3 bg-gray-50 rounded-xl border focus:border-indigo-500 outline-none">
                </div>
                
                <div class="p-3 bg-indigo-50 rounded-xl border border-indigo-100">
                    <p class="text-xs font-bold text-indigo-600 mb-2">Uygun YaÅŸ AralÄ±klarÄ±:</p>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <label class="flex items-center gap-2"><input type="checkbox" name="ageRange" value="18-24"> 18-24 YaÅŸ</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="ageRange" value="25-35"> 25-35 YaÅŸ</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="ageRange" value="35+"> 35+ YaÅŸ</label>
                    </div>
                </div>

                <input id="phone" type="text" placeholder="Ä°letiÅŸim NumarasÄ±" class="w-full p-3 bg-gray-50 rounded-xl border focus:border-indigo-500 outline-none">
                <textarea id="description" placeholder="Aranan ÅŸartlar ve iÅŸ detaylarÄ±..." class="w-full p-3 bg-gray-50 rounded-xl border h-24 focus:border-indigo-500 outline-none"></textarea>
                
                <div class="flex gap-2 pt-2">
                    <button onclick="addJob()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg">YayÄ±nla</button>
                    <button onclick="closePostModal()" class="w-full bg-gray-100 text-gray-600 py-3 rounded-xl font-bold">Kapat</button>
                </div>
            </div>
        </div>
    </div>

    <div id="messageModal" class="fixed inset-0 bg-black bg-opacity-50 z-[90] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-indigo-700">Mesaj GÃ¶nder</h3>
            <textarea id="msgText" placeholder="Merhaba, iÅŸ ile ilgileniyorum..." class="w-full p-3 bg-gray-50 rounded-xl border h-32 focus:border-indigo-500 outline-none mb-4"></textarea>
            <input type="hidden" id="currentJobId">
            <div class="flex gap-2">
                <button onclick="sendMessage()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg">GÃ¶nder</button>
                <button onclick="document.getElementById('messageModal').classList.add('hidden')" class="w-full bg-gray-100 text-gray-600 py-3 rounded-xl font-bold">Ä°ptal</button>
            </div>
        </div>
    </div>

    <div id="inboxModal" class="fixed inset-0 bg-black bg-opacity-50 z-[90] hidden flex items-center justify-center p-4 text-indigo-900">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-indigo-700">Gelen BaÅŸvurular</h3>
                <button onclick="document.getElementById('inboxModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="messageList" class="space-y-3">
                </div>
        </div>
    </div>

    <script>
        let userType = '';
        let userAge = 0;

        // UygulamayÄ± BaÅŸlatma (Ä°ÅŸ Arayan / Ä°ÅŸveren SeÃ§imi)
        function startApp(type) {
            userType = type;
            document.getElementById('loginModal').classList.add('hidden');
            if(type === 'seeker') {
                document.getElementById('ageModal').classList.remove('hidden');
            } else {
                document.getElementById('postBtn').classList.remove('hidden');
                updateUI();
            }
        }

        // KullanÄ±cÄ± YaÅŸÄ±nÄ± Kaydetme
        function saveAge() {
            userAge = parseInt(document.getElementById('userAge').value);
            if(!userAge) return alert("LÃ¼tfen yaÅŸÄ±nÄ± gir!");
            document.getElementById('ageModal').classList.add('hidden');
            updateUI();
        }

        // ArayÃ¼zÃ¼ GÃ¼ncelleme (Badge AyarÄ±)
        function updateUI() {
            document.getElementById('userBadge').innerText = userType === 'seeker' ? `ğŸ‘¤ Arayan (${userAge} YaÅŸ)` : 'ğŸ’¼ Ä°ÅŸ Veren';
            loadJobs();
        }

        // Ä°lanlarÄ± Sunucudan Ã‡ekme ve Listeleme
        async function loadJobs() {
            const res = await fetch('/api/jobs');
            const jobs = await res.json();
            const list = document.getElementById('jobList');
            
            list.innerHTML = jobs.map(j => {
                // YaÅŸ Uygunluk KontrolÃ¼
                let isAgeFit = true;
                if(userType === 'seeker') {
                    const ranges = j.age_range.split(', ');
                    isAgeFit = ranges.some(range => {
                        if(range === '35+' && userAge >= 35) return true;
                        const [min, max] = range.split('-').map(Number);
                        return userAge >= min && userAge <= max;
                    });
                }

                return `
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 flex flex-col gap-3 transition hover:shadow-md">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="font-bold text-lg text-indigo-900 leading-tight">${j.title}</h3>
                            <div class="flex flex-wrap gap-2 mt-2">
                                <span class="text-[10px] bg-indigo-50 text-indigo-600 font-bold px-2 py-0.5 rounded-full"><i class="fa-solid fa-location-dot"></i> ${j.location}</span>
                                <span class="text-[10px] bg-orange-50 text-orange-600 font-bold px-2 py-0.5 rounded-full"><i class="fa-solid fa-user-tag"></i> ${j.age_range}</span>
                            </div>
                        </div>
                        <span class="text-green-600 font-extrabold text-lg">${j.salary}</span>
                    </div>
                    <p class="text-sm text-gray-600">${j.description}</p>
                    
                    ${!isAgeFit ? `<p class="text-red-500 text-[10px] font-bold italic">âš ï¸ YaÅŸ aralÄ±ÄŸÄ±nÄ±z bu ilan iÃ§in uygun olmayabilir.</p>` : ''}

                    <div class="flex gap-2 mt-2">
                        ${userType === 'seeker' ? `
                            <a href="tel:${j.phone}" class="flex-1 bg-indigo-50 text-indigo-700 text-center py-3 rounded-2xl text-sm font-bold border border-indigo-100">ğŸ“ Ara</a>
                            <button onclick="openMessageModal(${j.id})" class="flex-1 bg-indigo-600 text-white py-3 rounded-2xl text-sm font-bold shadow-md">ğŸ’¬ Mesaj</button>
                        ` : `
                            <button onclick="showMessages(${j.id})" class="flex-1 bg-indigo-50 text-indigo-700 py-3 rounded-2xl text-sm font-bold border border-indigo-100">ğŸ“¥ MesajlarÄ± GÃ¶r</button>
                        `}
                    </div>
                </div>`;
            }).join('');
        }

        // Ä°lan Verme ModalÄ±nÄ± AÃ§/Kapat
        function openPostModal() { document.getElementById('postModal').classList.remove('hidden'); }
        function closePostModal() { document.getElementById('postModal').classList.add('hidden'); }

        // Yeni Ä°lan Ekleme (Sunucuya GÃ¶nderme)
        async function addJob() {
            // SeÃ§ilen YaÅŸ AralÄ±klarÄ±nÄ± Topla
            const selectedAges = Array.from(document.querySelectorAll('input[name="ageRange"]:checked')).map(c => c.value);
            if(selectedAges.length === 0) return alert("En az bir yaÅŸ grubu seÃ§melisiniz!");

            const data = {
                title: document.getElementById('title').value,
                salary: document.getElementById('salary').value,
                location: document.getElementById('location').value,
                phone: document.getElementById('phone').value,
                description: document.getElementById('description').value,
                age_range: selectedAges.join(', ')
            };
            
            await fetch('/api/jobs', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            closePostModal();
            loadJobs();
        }

        // MesajlaÅŸma Penceresini AÃ§ma
        function openMessageModal(jobId) {
            document.getElementById('currentJobId').value = jobId;
            document.getElementById('messageModal').classList.remove('hidden');
        }

        // Mesaj GÃ¶nderme Ä°ÅŸlemi
        async function sendMessage() {
            const data = {
                job_id: document.getElementById('currentJobId').value,
                sender_age: userAge,
                message_text: document.getElementById('msgText').value
            };
            if(!data.message_text) return alert("Mesaj boÅŸ olamaz!");

            await fetch('/api/messages', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            alert("MesajÄ±nÄ±z iÅŸverene iletildi! BaÅŸarÄ±lar.");
            document.getElementById('messageModal').classList.add('hidden');
            document.getElementById('msgText').value = '';
        }

        // Ä°ÅŸverenin Gelen MesajlarÄ± GÃ¶rmesi
        async function showMessages(jobId) {
            const res = await fetch(`/api/messages/${jobId}`);
            const messages = await res.json();
            const list = document.getElementById('messageList');
            
            document.getElementById('inboxModal').classList.remove('hidden');
            
            if(messages.length === 0) {
                list.innerHTML = `<p class="text-center text-gray-400 py-10">HenÃ¼z baÅŸvuru yok.</p>`;
                return;
            }

            list.innerHTML = messages.map(m => `
                <div class="bg-gray-50 p-4 rounded-2xl border border-gray-100">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full font-bold">Aday YaÅŸÄ±: ${m.sender_age}</span>
                        <span class="text-[10px] text-gray-400 font-semibold">${new Date(m.timestamp).toLocaleDateString('tr-TR')}</span>
                    </div>
                    <p class="text-sm text-gray-700 italic">"${m.message_text}"</p>
                </div>
            `).join('');
        }
    </script>
</body>
</html>